name: MVDR Dataset Pipeline

on:
  workflow_dispatch:

jobs:
  build-mvdr-dataset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # Setup MATLAB + License
      # -------------------------------
      - name: Set up MATLAB with license
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2024b
          products: Signal_Processing_Toolbox
          email: ${{ secrets.MW_EMAIL }}
          password: ${{ secrets.MW_PASSWORD }}

      # -------------------------------
      # Cache Pre Dataset ZIP
      # -------------------------------
      - name: Cache Pre_MVDR_Dataset.zip
        uses: actions/cache@v4
        id: cache-pre
        with:
          path: Pre_MVDR_Dataset.zip
          key: pre-mvdr-dataset-v1

      # -------------------------------
      # Download only if not cached
      # -------------------------------
      - name: Download Pre Dataset from Transfer.sh
        if: steps.cache-pre.outputs.cache-hit != 'true'
        run: |
          wget -O Pre_MVDR_Dataset.zip https://transfer.sh/YOUR_FILE_ID/Pre_MVDR_Dataset.zip

      # -------------------------------
      # Extract dataset cleanly
      # -------------------------------
      - name: Extract dataset
        run: |
          unzip -o Pre_MVDR_Dataset.zip
          root=$(unzip -Z1 Pre_MVDR_Dataset.zip | head -1 | cut -d/ -f1)
          mv "$root" Pre_MVDR_Dataset

      # -------------------------------
      # Show dataset paths
      # -------------------------------
      - name: Show dataset paths
        run: |
          echo "Pre dataset:"
          realpath Pre_MVDR_Dataset

      # -------------------------------
      # Run MATLAB script
      # -------------------------------
      - name: Run MVDR MATLAB Script
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath(pwd);
            disp("Pre path:");
            disp(fullfile(pwd,"Pre_MVDR_Dataset"));
            disp("Post path:");
            disp(fullfile(pwd,"Post_MVDR_Dataset"));
            run('audio/beamforming/generate_mixture_NoReverb_MVDR_V1_Final.m');

      # -------------------------------
      # Zip output
      # -------------------------------
      - name: Zip Post Dataset
        run: zip -r Post_MVDR_Dataset.zip Post_MVDR_Dataset

      # -------------------------------
      # Upload artifact
      # -------------------------------
      - name: Upload Post Dataset Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Post_MVDR_Dataset
          path: Post_MVDR_Dataset.zip
